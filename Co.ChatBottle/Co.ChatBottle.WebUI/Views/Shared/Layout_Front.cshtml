<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
    <title>流浪瓶-ChatBottle</title>
    <link href="~/Content/component/bootstrap-3.3.7/css/bootstrap.min.css" rel="stylesheet">
    <link href="~/Content/component/datepicker/bootstrap-datetimepicker.min.css" rel="stylesheet">

    <script src="~/Content/js/jquery.min.js"></script>
    <script src="~/Content/component/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script src="~/Content/component/datepicker/bootstrap-datetimepicker.min.js"></script>
    <script src="~/Content/component/datepicker/bootstrap-datetimepicker.zh-CN.js"></script>
    <script src="http://api.map.baidu.com/api?v=2.0&ak=7aQjxiU2MrATqBNEdW9SDeG9"></script>
    <script src="~/Content/js/common.js"></script>

</head>
<body>
    <style>
        .unactive {
            opacity: 0.6
        }

        .active {
            opacity: 1 !important
        }
    </style>

    @RenderBody()

    @*服务地址*@
    <script>
        //全局变量
        //var serviceurl = "http://www.buyshoes.club:9001/";
        var serviceurl = "http://localhost:9001/";
        //var serviceurl = "http://10.1.8.4:9014/";
        var userid = 0;//定义全局用户id
        var expiredHour = 24;
        var latitude = "";
        var longitude = "";

        var province = "";
        var city = "";
        var district = "";
        var street = "";
        var streetNumber = "";
        var addressdetail = "";

        var websocketaddress = "ws://127.0.0.1:9017";//websocket地址

        var pageName = {
            ProfileSetting: "/Home/ProfileSetting",
            ThrowBottle: "/Home/ThrowBottle",
            PickBottle: "/Home/PickBottle",
            MyBottle: "/Home/MyBottle",
            BottleDetail: "/Home/BottleDetail",
            Index: "",
        };
        
        function checkUserValid() {
            userid = localStorage.getItem("userid");
            var expiredtimestr = localStorage.getItem("expiredTime");
            var nowTime = new Date();

            if (userid == undefined || isNaN(userid) || expiredtimestr == undefined) {
                //如果没有用户缓存，则跳转到欢迎页
                return false;
            }
            var expiredTime = new Date(expiredtimestr)

            var totalTimeMs = nowTime.getTime() - expiredTime.getTime();  //时间差的毫秒数
            if (isNaN(totalTimeMs) || totalTimeMs > expiredHour * 60 * 60 * 1000) {
                //如果数据过期，则跳转到欢迎页
                localStorage.removeItem("userid");
                localStorage.removeItem("expiredTime");
                return false;
            }

            var valid = false;
            //服务校验此用户是否有效
            $.ajax({
                url: serviceurl + "/api/User/QueryById",
                data: { id: userid },
                async: false,
                success: function (result) {
                    if (result != undefined && result.ErrorCode == 0 && result.Result != undefined) {
                        valid = true;//用户存在则通过，不存在则不通过
                        //重新设置有效期
                        localStorage.setItem("userid", userid);
                        localStorage.setItem("expiredTime", nowTime);
                    }
                }, error: function (result) {

                }
            });
            
            return valid;
        }
    </script>
</body>
</html>