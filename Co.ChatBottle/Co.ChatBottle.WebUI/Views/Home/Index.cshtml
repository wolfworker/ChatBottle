@{
    Layout = "~/Views/Shared/Layout_Front.cshtml";
    ViewBag.Title = "流浪瓶";
}
<style>
    .mainDiv {
        margin: 0;
        padding: 0;
        font-size: 20px;
        text-align: center;
    }

    .head {
        background-color: khaki;
        position: absolute;
        width: 100%;
        height: 6%;
    }

    #rootdiv {
        top: 6%;
        width: 100%;
        position: absolute;
        height: 85%;
        background-image: url(../../Content/img/background.jpg);
        background-repeat: no-repeat;
        background-size: cover;
    }

    .foot {
        width: 100%;
        height: 9%;
        position: absolute;
        background-color: khaki;
        bottom: 0;
    }

    .icon {
        width: 32px;
    }
</style>

<div class="mainDiv">

    <div class="head">
        <span>流浪瓶 V1.0</span>
        <img class="icon" style="float:right" id="profilesetting" src="~/Content/img/icon_setting.png" />
    </div>
    <div id="rootdiv">
    </div>
    <div class="foot">
        <div style="padding-top:2%">
            <div class="col-xs-4">
                <img class="icon" id="throwbottle" src="~/Content/img/icon_throwbottle.png" />
            </div>
            <div class="col-xs-4">
                <img class="icon" id="pickbottle" src="~/Content/img/icon_pickbottle.png" />
            </div>
            <div class="col-xs-4">
                <img class="icon" id="mybottle" src="~/Content/img/icon_mybottles.png" />
            </div>
        </div>
    </div>
</div>

<script>
    $(function(){
        init();
    });

    var loadPage = function (pageName, param) {
        var pagePath = pageName;
        if (param != undefined && param != "") {
            pagePath += param;
        }
        $("#rootdiv").load(pagePath);
    }

    var loadPageByIndex = function (pageIndex) {
        switch (pageIndex) {
            case 1:
                loadPage(pageName.ProfileSetting);
                break;
            case 2:
                loadPage(pageName.ThrowBottle);
                break;
            case 3:
                loadPage(pageName.PickBottle);
                break;
            case 4:
                loadPage(pageName.MyBottle);
                break;
            case 5:
                loadPage(pageName.BottleDetail);
                break;
            case 0:
            default:
                loadPage(pageName.Index);
                break;
        }
    }

    var getLocation = function () {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showPosition);
        }
        else {
            //x.innerHTML = "Geolocation is not supported by this browser.";
            //不支持定位
        }
    }

    var showPosition = function (position) {
        latitude = position.coords.latitude;
        longitude = position.coords.longitude;

        // 百度地图API功能
        var point = new BMap.Point(longitude, latitude);
        var geoc = new BMap.Geocoder();
        geoc.getLocation(point, function (rs) {
            var data = {};
            data.userid = userid;
            data.longitude = longitude;
            data.latitude = latitude;

            var addComp = rs.addressComponents;
            data.province = province = addComp.province;
            data.city = city = addComp.city;
            data.district = district = addComp.district;
            data.street = street = addComp.street;
            data.streetNumber = streetNumber = addComp.streetNumber;
            data.addressdetail = addressdetail = rs.business;

            $.post(serviceurl + "/api/position/add", data);
        });
    }

    //连接websocket
    var connectWebsocket = function () {
        ws = new WebSocket(websocketaddress);
        ws.onopen = function (e) {
            alert("连接上了websocket服务器");
            //var msg = document.createElement('div');
            //msg.style.color = '#0f0';
            //msg.innerHTML = "Server > connection open.";
            //msgContainer.appendChild(msg);
            ws.send(userid);
        };
        ws.onmessage = function (e) {
            debugger;
            //服务器回发消息，客户端即时处理
            var currentbottleid = $("#bottleId").val();
            var backbottleid = 0;
            var backsenderid = 0;
            var backmsg = e.data;
            var msgArr = backmsg.split(encypt);
            if (msgArr.length > 2) {
                backbottleid = msgArr[0];
                backsenderid = msgArr[1];
                backmsg = msgArr[2];
            }
            //相同瓶子，且是对方发送的消息
            if (backbottleid == currentbottleid) {
                //
                var html = "<br />";
                html += '<textarea style="width:100%;text-align:left" readonly="readonly">' + backmsg + '</textarea>';
                html += "<br />";
                $("#bottle").append(html);
                if (backsenderid == userid) {
                    //自己发的消息
                    debugger;
                } else {
                    //对方发的消息，更新为已读状态
                    debugger;
                }
            }
        };
        ws.onerror = function (e) {
            //服务器出错，客户端即时处理

            //var msg = document.createElement('div');
            //msg.style.color = '#0f0';
            //msg.innerHTML = 'Server > ' + e.data;
            //msgContainer.appendChild(msg);
        };
        ws.onclose = function (e) {
            //服务器关闭连接，客户端即时处理
            //var msg = document.createElement('div');
            //msg.style.color = '#0f0';
            //msg.innerHTML = "Server > connection closed by server.";
            //msgContainer.appendChild(msg);
        };
        //text.focus();
    }

    //退出
    var quit = function () {
        //客户端 退出
        if (ws) {
            ws.close();
            //var msg = document.createElement('div');
            //msg.style.color = '#0f0';
            //msg.innerHTML = 'Server > connection closed.';
            //msgContainer.appendChild(msg);
            ws = null;
        }
    }

    var send = function (content) {
        //客户端发送消息
        if (content == undefined || content == "") {
            return;
        }
        ws.send(content);
        //setTimeout(function () {
        //    msgContainer.scrollTop = msgContainer.getBoundingClientRect().height;
        //}, 100);
        //text.value = '';
        //text.focus();
    }

    $("#profilesetting").click(function () {
        loadPage(pageName.ProfileSetting);
    });

    $("#throwbottle").click(function () {
        loadPage(pageName.ThrowBottle);
    });

    $("#pickbottle").click(function () {
        loadPage(pageName.PickBottle);
    });

    $("#mybottle").click(function () {
        loadPage(pageName.MyBottle);
        getLocation();
    });

    $("#topbtn").click(function () {
        //顶部按钮事件

    });

    var init = function () {
        getLocation();
        connectWebsocket();
        if (@ViewBag.sourceFlag!= -1) {
            loadPageByIndex(@ViewBag.sourceFlag);//防止跳到主页 死循环
        }

        if (!checkUserValid()) {
            window.location.href = "/welcome/index";
        }
    }

</script>