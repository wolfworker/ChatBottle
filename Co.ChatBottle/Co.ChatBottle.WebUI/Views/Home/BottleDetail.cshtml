@{
    ViewBag.Title = "流浪瓶";
}

<div id="detail_bottle" data-receiveid="" style="overflow:auto;height: 90%;"></div>
<input type="hidden" id="detail_bottleId" value="0" />
<input type="hidden" id="receiverid" value="0" />
<p></p>
<input type="text" id="replyContent" />
<input type="button" class="btn-primary" id="btnReply" value="发送" />

<script type="text/javascript">
    $("#detail_bottleId").val(@ViewBag.bottleId);
    $("#btnReply").attr("disabled", false);
    $("#replyContent").attr("disabled", false);

    $.ajax({
        url: serviceurl + "/api/ChatRecord/QueryChatByBottleId",
        type: "get",
        data: { bottleid: @ViewBag.bottleId },
        success: function (result) {
            if (result.ErrorCode == 0 && result.Result != undefined && result.Result.length > 0) {
                var chatRecord = result.Result;
                //接收人id赋值
                $("#receiverid").val(chatRecord[0].ReceiverID);
                if (userid != chatRecord[0].SenderID) {
                    //别人扔的瓶子
                    $("#receiverid").val(chatRecord[0].SenderID);
                }

                var html = "";
                $.each(chatRecord,function (index, item) {
                    html += "<br />";
                    html += '<textarea style="width:100%;text-align:' + (item.SenderID != userid ? "left;float:left;" : "right;float:right;background-color: lightgreen;") + ';height: 35px" readonly="readonly">' + item.ChatText + '</textarea>';
                    //html += '<textarea style="width:100%;text-align:' + (item.SenderID != userid ? "left" : "right") + ';height: 35px" readonly="readonly">' + item.ChatText + '</textarea>';
                });
                $("#detail_bottle").append(html);
                $("#detail_bottle")[0].scrollTop = $("#detail_bottle")[0].scrollHeight;

                //打开瓶子界面时 更新聊天记录状态为已读
                var data = {};
                data.BottleID = @ViewBag.bottleId;
                data.ReceiverID = userid;
                $.post(serviceurl + "/api/ChatRecord/UpdateChatStatus", data);

                var receiverid = $("#receiverid").val();
                if (receiverid == undefined || receiverid == "" || receiverid == 0) {
                    $("#btnReply").attr("disabled", true);
                    $("#replyContent").attr("disabled", true);
                    alert("瓶子还没被捡起哦")
                }

            } else {
                $("#detail_bottle").append("这是个空瓶子。。。");
                $("#btnReply").attr("disabled", true);
                $("#replyContent").attr("disabled", true);
            }
        },
        error: function (result) {
            $("#detail_bottle").append("系统异常啦");
            $("#btnReply").attr("disabled", true);
            $("#replyContent").attr("disabled", true);

        }
    });

    var sendmessage = function () {
        //发送消息
        var content = $("#replyContent").val();
        if (content != undefined && content != "") {
            content = encypt + $("#detail_bottleId").val() + encypt + $("#receiverid").val() + encypt + content;
            send(content);
            $("#replyContent").val('');
        } else {
            alert("发送内容为空！")
        }
    }

    $("#btnReply").click(function(){
        sendmessage();
    });

    document.onkeydown = function (e) {
        if (e.keyCode == 13) {
            console.log("回车事件");
            sendmessage();
        }
    }

</script>
